{% assign item = include.item %}
<div class="d-none d-md-block publication-item" {% if item.tag %}data-tag="{{ item.tag }}"{% endif %}>
    <div class="row no-gutters border-bottom border-gray px-3">
        {% if item.cover %}
        <div class="col-md-3 col-xl-2 mb-md-0 p-md-3">
            <img data-src="{{ item.cover }}" alt="{{ item.title }}" class="lazy w-100 rounded-sm" src="assets/images/empty_300x200.png">
        </div>
        {% endif %}
        <div class="{% if item.cover %}col-md-9 col-xl-10{% else %}col-12{% endif %} p-3 pl-md-0">
            <h6 class="mt-0 mb-1 font-weight-normal">{{ item.title }}</h6>
            <p class="mt-0 mb-0 small">{% include widgets/author_list.html authors=item.authors %}</p>
            <p class="mt-0 mb-0 small">{{ item.pub_pre }}<i>{{ item.pub }}</i>{{ item.pub_post }} {{ item.pub_date }} {{ item.pub_last }}</p>

            <p class="small pb-0 mb-0 lh-125 text-muted abstract-links">
                {% for link in item.links %}
                {% if link[1].url %}
                <a target="{{ link[1]['target'] }}" href="{{ link[1]['url'] }}">[{{ link[0] }}]</a>
                {% else %}
                <a target="_blank" href="{{ link[1] }}">[{{ link[0] }}]</a>
                {% endif %}
                {% endfor %}
            </p>
        </div>
    </div>
</div>

<div class="d-md-none publication-item" {% if item.tag %}data-tag="{{ item.tag }}"{% endif %}>
    <div class="row no-gutters border-bottom border-gray px-3">
        {% if item.cover %}
        <div class="col-3 mb-3 p-3">
            <img data-src="{{ item.cover }}" alt="{{ item.title }}" class="lazy w-100 rounded-sm" src="assets/images/empty_300x200.png">
        </div>
        {% endif %}
        <div class="{% if item.cover %}col-9{% else %}col-12{% endif %} p-3">
            <h6 class="mt-0 mb-1 font-weight-normal">{{ item.title }}</h6>
            <p class="mt-0 mb-0 small">{% include widgets/author_list.html authors=item.authors %}</p>
            <p class="mt-0 mb-0 small">{{ item.pub_pre }}<i>{{ item.pub }}</i>{{ item.pub_post }} {{ item.pub_date }} {{ item.pub_last }}</p>
            <p class="mt-0 mb-0 small text-muted d-none d-sm-block">{{ item.abstract }}</p>

            <p class="small pb-0 mb-0 lh-125 text-muted abstract-links">
                {% for link in item.links %}
                {% if link[1].url %}
                <a target="{{ link[1]['target'] }}" href="{{ link[1]['url'] }}">[{{ link[0] }}]</a>
                {% else %}
                <a target="_blank" href="{{ link[1] }}">[{{ link[0] }}]</a>
                {% endif %}
                {% endfor %}
            </p>
        </div>
    </div>
</div>

<script>
    function drawConnectingLines() {
        var existingSvg = document.getElementById('connection-svg');
        if (existingSvg) {
            existingSvg.parentNode.removeChild(existingSvg);
        }

        var taggedItems = document.querySelectorAll('.publication-item[data-tag]');
        var tags = {};
        taggedItems.forEach(function(item) {
            if (window.getComputedStyle(item).display === 'none') {
                return;
            }
            var tag = item.dataset.tag;
            if (!tags[tag]) {
                tags[tag] = [];
            }
            tags[tag].push(item);
        });

        if (Object.keys(tags).length === 0) {
            return;
        }

        var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.id = 'connection-svg';
        svg.style.position = 'absolute';
        svg.style.top = '0';
        svg.style.left = '0';
        svg.style.width = '100%';
        svg.style.height = document.body.scrollHeight + 'px';
        svg.style.pointerEvents = 'none';
        svg.style.zIndex = '-1';

        var defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
        defs.innerHTML = '<marker id="circle-marker" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto"><circle cx="4" cy="4" r="3" style="fill: #888;"/></marker>';
        svg.appendChild(defs);

        for (var tagName in tags) {
            var items = tags[tagName];
            if (items.length > 1) {
                items.sort(function(a, b) {
                    return a.getBoundingClientRect().top - b.getBoundingClientRect().top;
                });

                for (var i = 0; i < items.length - 1; i++) {
                    var item1 = items[i];
                    var item2 = items[i+1];

                    var rect1 = item1.getBoundingClientRect();
                    var rect2 = item2.getBoundingClientRect();

                    var line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    
                    var x = rect1.left + 15;
                    var y1 = rect1.top + window.scrollY + (rect1.height / 2);
                    var y2 = rect2.top + window.scrollY + (rect2.height / 2);

                    line.setAttribute('x1', x);
                    line.setAttribute('y1', y1);
                    line.setAttribute('x2', x);
                    line.setAttribute('y2', y2);
                    line.setAttribute('stroke', '#888');
                    line.setAttribute('stroke-width', '1.5');
                    line.setAttribute('marker-start', 'url(#circle-marker)');
                    line.setAttribute('marker-end', 'url(#circle-marker)');
                    svg.appendChild(line);
                }
            }
        }
        document.body.appendChild(svg);
    }

    if (!window.connectionListenersAdded) {
        document.addEventListener('DOMContentLoaded', drawConnectingLines);
        window.addEventListener('resize', drawConnectingLines);
        window.connectionListenersAdded = true;
    }
</script>